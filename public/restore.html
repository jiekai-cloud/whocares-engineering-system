<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>ä¸€éµè³‡æ–™æ¢å¾©</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        h1 {
            color: #667eea;
            margin: 0 0 20px 0;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        #status {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”„ ä¸€éµè³‡æ–™æ¢å¾©</h1>
        <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå¾å‚™ä»½æ¢å¾©æ‚¨çš„æ‰€æœ‰è³‡æ–™</p>

        <button class="btn" onclick="restore()">
            ç«‹å³æ¢å¾©è³‡æ–™
        </button>

        <div id="status"></div>
    </div>

    <script>
        async function restore() {
            const status = document.getElementById('status');
            status.innerHTML = '<p>â³ æ­£åœ¨è¼‰å…¥å‚™ä»½...</p>';

            try {
                // è¼‰å…¥å‚™ä»½
                const res = await fetch('/backup_JW2601003.json');
                const data = await res.json();

                status.innerHTML = '<p>âœ… å‚™ä»½è¼‰å…¥æˆåŠŸ</p><p>â³ æ­£åœ¨æ¢å¾©åˆ°è³‡æ–™åº«...</p>';

                // é–‹å•Ÿ IndexedDB
                const db = await new Promise((resolve, reject) => {
                    const req = indexedDB.open('BuildTrack', 1);
                    req.onsuccess = () => resolve(req.result);
                    req.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('data')) {
                            db.createObjectStore('data');
                        }
                    };
                    req.onerror = () => reject(req.error);
                });

                const save = (key, value) => new Promise((resolve) => {
                    const tx = db.transaction(['data'], 'readwrite');
                    tx.objectStore('data').put(value, key).onsuccess = () => resolve();
                });

                // æ¢å¾©æ‰€æœ‰è³‡æ–™
                await save('bt_projects', data.projects || []);
                await save('bt_customers', data.customers || []);
                await save('bt_vendors', data.vendors || []);
                await save('bt_team', data.teamMembers || []);
                await save('bt_leads', data.leads || []);

                status.innerHTML = `
                    <h2>âœ… æ¢å¾©å®Œæˆï¼</h2>
                    <p>å·²æ¢å¾©ï¼š</p>
                    <ul style="text-align: left; display: inline-block;">
                        <li>å°ˆæ¡ˆï¼š${data.projects?.length || 0} å€‹</li>
                        <li>å®¢æˆ¶ï¼š${data.customers?.length || 0} å€‹</li>
                        <li>å» å•†ï¼š${data.vendors?.length || 0} å€‹</li>
                        <li>åœ˜éšŠæˆå“¡ï¼š${data.teamMembers?.length || 0} ä½</li>
                        <li>æ½›å®¢ï¼š${data.leads?.length || 0} å€‹</li>
                    </ul>
                    <p><strong>3ç§’å¾Œè‡ªå‹•è·³è½‰...</strong></p>
                `;

                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);

            } catch (error) {
                status.innerHTML = `<p style="color: red;">âŒ éŒ¯èª¤ï¼š${error.message}</p>`;
            }
        }
    </script>
</body>

</html>