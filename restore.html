<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>é¸æ“‡æ€§è³‡æ–™æ¢å¾©</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            margin: 0 0 10px 0;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .options {
            margin: 20px 0;
        }

        .option {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 12px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .option:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .option input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
        }

        .option-content {
            flex: 1;
        }

        .option-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }

        .option-count {
            color: #667eea;
            font-weight: bold;
        }

        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            color: #856404;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #status {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            display: none;
        }

        #status.show {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”„ é¸æ“‡æ€§è³‡æ–™æ¢å¾©</h1>
        <p class="subtitle">å¾å‚™ä»½ä¸­é¸æ“‡æ‚¨è¦æ¢å¾©çš„è³‡æ–™é¡å‹</p>

        <div class="warning">
            <strong>âš ï¸ æ³¨æ„ï¼š</strong> æ¢å¾©è³‡æ–™æœƒ<strong>è¦†è“‹</strong>ç¾æœ‰çš„ç›¸åŒé¡å‹è³‡æ–™ã€‚å»ºè­°å…ˆå‚™ä»½ç•¶å‰è³‡æ–™å†åŸ·è¡Œæ¢å¾©ã€‚
        </div>

        <div class="options" id="options">
            <label class="option">
                <input type="checkbox" id="restore_customers" checked>
                <div class="option-content">
                    <div class="option-title">å®¢æˆ¶è³‡æ–™</div>
                    <div class="option-count" id="count_customers">è¼‰å…¥ä¸­...</div>
                </div>
            </label>

            <label class="option">
                <input type="checkbox" id="restore_vendors" checked>
                <div class="option-content">
                    <div class="option-title">å» å•†è³‡æ–™</div>
                    <div class="option-count" id="count_vendors">è¼‰å…¥ä¸­...</div>
                </div>
            </label>

            <label class="option">
                <input type="checkbox" id="restore_team" checked>
                <div class="option-content">
                    <div class="option-title">åœ˜éšŠæˆå“¡</div>
                    <div class="option-count" id="count_team">è¼‰å…¥ä¸­...</div>
                </div>
            </label>

            <label class="option">
                <input type="checkbox" id="restore_leads" checked>
                <div class="option-content">
                    <div class="option-title">æ½›åœ¨å®¢æˆ¶</div>
                    <div class="option-count" id="count_leads">è¼‰å…¥ä¸­...</div>
                </div>
            </label>

            <label class="option">
                <input type="checkbox" id="restore_projects">
                <div class="option-content">
                    <div class="option-title">å°ˆæ¡ˆè³‡æ–™</div>
                    <div class="option-count" id="count_projects">è¼‰å…¥ä¸­...</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">âš ï¸ é è¨­ä¸å‹¾é¸ï¼Œä»¥ä¿ç•™æ‚¨æœ€æ–°çš„å°ˆæ¡ˆè³‡æ–™</div>
                </div>
            </label>

            <label class="option">
                <input type="checkbox" id="restore_inventory" checked>
                <div class="option-content">
                    <div class="option-title">åº«å­˜è³‡æ–™</div>
                    <div class="option-count" id="count_inventory">è¼‰å…¥ä¸­...</div>
                </div>
            </label>

            <label class="option">
                <input type="checkbox" id="restore_attendance" checked>
                <div class="option-content">
                    <div class="option-title">è€ƒå‹¤è–ªè³‡</div>
                    <div class="option-count" id="count_attendance">è¼‰å…¥ä¸­...</div>
                </div>
            </label>
        </div>

        <button class="btn" id="restoreBtn" onclick="restore()">
            é–‹å§‹æ¢å¾©é¸ä¸­çš„è³‡æ–™
        </button>

        <div id="status"></div>
    </div>

    <script>
        let backupData = null;

        async function loadBackup() {
            try {
                // ä½¿ç”¨ç²¾ç°¡çš„å‚™ä»½æª”æ¡ˆ
                const res = await fetch('./essential_backup.json');
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                backupData = await res.json();

                document.getElementById('count_customers').textContent = `${backupData.customers?.length || 0} å€‹å®¢æˆ¶`;
                document.getElementById('count_vendors').textContent = `${backupData.vendors?.length || 0} å€‹å» å•†`;
                document.getElementById('count_team').textContent = `${backupData.teamMembers?.length || 0} ä½æˆå“¡`;
                document.getElementById('count_leads').textContent = `${backupData.leads?.length || 0} å€‹æ½›å®¢`;
                document.getElementById('count_projects').textContent = `${backupData.projects?.length || 0} å€‹å°ˆæ¡ˆ`;
                document.getElementById('count_inventory').textContent = `${backupData.inventory?.length || 0} é …åº«å­˜`;
                document.getElementById('count_attendance').textContent = `${backupData.attendance?.length || 0} ç­†æ‰“å¡`;

            } catch (error) {
                alert('ç„¡æ³•è¼‰å…¥å‚™ä»½æª”æ¡ˆ: ' + error.message);
            }
        }

        async function restore() {
            const status = document.getElementById('status');
            const restoreBtn = document.getElementById('restoreBtn');

            // æª¢æŸ¥æ˜¯å¦è‡³å°‘é¸æ“‡ä¸€é …
            const selected = {
                customers: document.getElementById('restore_customers').checked,
                vendors: document.getElementById('restore_vendors').checked,
                team: document.getElementById('restore_team').checked,
                leads: document.getElementById('restore_leads').checked,
                projects: document.getElementById('restore_projects').checked,
                inventory: document.getElementById('restore_inventory').checked,
                attendance: document.getElementById('restore_attendance').checked
            };

            if (!Object.values(selected).some(v => v)) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …è¦æ¢å¾©çš„è³‡æ–™');
                return;
            }

            restoreBtn.disabled = true;
            status.className = 'show';
            status.innerHTML = '<p>â³ æ­£åœ¨æ¢å¾©è³‡æ–™...</p>';

            try {
                // é–‹å•Ÿ IndexedDB
                const db = await new Promise((resolve, reject) => {
                    const req = indexedDB.open('BuildTrack', 1);
                    req.onsuccess = () => resolve(req.result);
                    req.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('data')) {
                            db.createObjectStore('data');
                        }
                    };
                    req.onerror = () => reject(req.error);
                });

                const save = (key, value) => new Promise((resolve) => {
                    const tx = db.transaction(['data'], 'readwrite');
                    tx.objectStore('data').put(value, key).onsuccess = () => resolve();
                });

                let restored = [];

                // æ ¹æ“šé¸æ“‡æ¢å¾©å°æ‡‰è³‡æ–™
                if (selected.customers) {
                    await save('bt_customers', backupData.customers || []);
                    restored.push(`å®¢æˆ¶ï¼š${backupData.customers?.length || 0} å€‹`);
                }

                if (selected.vendors) {
                    await save('bt_vendors', backupData.vendors || []);
                    restored.push(`å» å•†ï¼š${backupData.vendors?.length || 0} å€‹`);
                }

                if (selected.team) {
                    await save('bt_team', backupData.teamMembers || []);
                    restored.push(`åœ˜éšŠæˆå“¡ï¼š${backupData.teamMembers?.length || 0} ä½`);
                }

                if (selected.leads) {
                    await save('bt_leads', backupData.leads || []);
                    restored.push(`æ½›å®¢ï¼š${backupData.leads?.length || 0} å€‹`);
                }

                if (selected.projects) {
                    await save('bt_projects', backupData.projects || []);
                    restored.push(`å°ˆæ¡ˆï¼š${backupData.projects?.length || 0} å€‹`);
                }

                if (selected.inventory) {
                    await save('bt_inventory', backupData.inventory || []);
                    if (backupData.locations) await save('bt_inventory_locations', backupData.locations);
                    if (backupData.purchaseOrders) await save('bt_purchase_orders', backupData.purchaseOrders);
                    restored.push(`åº«å­˜èˆ‡åœ°é»ï¼š${backupData.inventory?.length || 0} é …`);
                }

                if (selected.attendance) {
                    await save('bt_attendance_records', backupData.attendance || []);
                    if (backupData.payroll) await save('bt_payroll_records', backupData.payroll);
                    restored.push(`è€ƒå‹¤èˆ‡è–ªè³‡ï¼š${backupData.attendance?.length || 0} ç­†`);
                }

                status.innerHTML = `
                    <h2 style="color: #28a745;">âœ… æ¢å¾©å®Œæˆï¼</h2>
                    <p>å·²æ¢å¾©ä»¥ä¸‹è³‡æ–™ï¼š</p>
                    <ul style="text-align: left; display: inline-block;">
                        ${restored.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                    <p><strong>3ç§’å¾Œè‡ªå‹•è·³è½‰åˆ°ä¸»é é¢...</strong></p>
                `;

                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);

            } catch (error) {
                status.innerHTML = `<p style="color: #dc3545;">âŒ æ¢å¾©å¤±æ•—ï¼š${error.message}</p>`;
                restoreBtn.disabled = false;
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥å‚™ä»½è³‡æ–™
        loadBackup();
    </script>
</body>

</html>